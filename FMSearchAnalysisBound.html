<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>周边查询</title>
    <link rel="stylesheet" href="css/style.css" />
  </head>
  <body>
    <!-- 加载地图容器 -->
    <div id="fengMap"></div>

    <!--查询结果-->
    <div id="resTable" class="resTable scroll">
      <table width="100%" cellpadding="0" cellspacing="0">
        <thead>
          <tr>
            <th style="width: 30px">行号</th>
            <th>模型名称</th>
            <th>模型FID</th>
            <th>楼层ID</th>
            <th>x坐标</th>
            <th>y坐标</th>
            <th>z坐标</th>
          </tr>
        </thead>
        <tbody id="tableCont"></tbody>
      </table>
    </div>

    <!-- 引入fengmap -->
    <script src="lib/fengmap.core.min.js"></script>
    <script>
      //获取版本号,设置title
      document.title = "周边查询";

      //定义全局map变量
      let map = null;
      //定义地图ID变量
      const fmapID = "1321274646113083394";

      const array = [];
      let searchRes = [];
      let selectR = 0;
      let point = [];

      // 矩形高度与宽度
      let width = 0;
      let height = 0;

      //定义多边形
      let polygonLayer = null;
      //搜索结果列表
      let resTableDom = null;
      //定义搜索分析类
      let searchAnalyser = null;

      //定义选中模型
      let selectedModel = null;

      window.onload = function () {
        //加载地图
        openMap();
        resTableDom = document.getElementById("resTable");
      };

      /**
       * 打开地图
       * */
      function openMap() {
        const mapOptions = {
          // 必要，地图容器
          container: document.getElementById("fengMap"),
          // 地图数据位置
          mapServerURL: "./data/" + fmapID,
          // 主题数据位置
          mapThemeURL: "./data/theme",
          // 设置主题
          defaultThemeName: "3b91d03288204d02368dd4f68fc1f189",
          // 默认聚焦楼层
          defaultFocusGroup: 2,
          // 初始显示楼层ID数组
          defaultVisibleGroups: [2],
          // 设置比例尺级别可缩放范围
          mapScaleLevelRange: [16, 23],
          // 默认比例尺级别设置为20级
          defaultMapScaleLevel: 21,
          defaultControlsPose: 0,
          // 是否支持单击模型高亮，false为单击时模型不高亮
          modelSelectedEffect: true,
          modelHoverEffect: true,
          // 悬停时间触发时间，默认1000
          modelHoverTime: 0,
          defaultViewMode: fengmap.FMViewMode.MODE_2D,
          // 必要，地图应用名称，通过蜂鸟云后台创建
          appName: "testMap",
          // 必要，地图应用密钥，通过蜂鸟云后台获取
          key: "b8cfac0873c3d803d45aaad0632d06ef",
        };

        //初始化地图对象
        map = new fengmap.FMMap(mapOptions);

        //打开Fengmap服务器的地图数据和主题
        map.openMapById(fmapID, function (error) {
          //打印错误信息
          console.log(error);
        });

        //地图加载完成事件
        map.on("loadComplete", function () {
          console.log("地图加载完成！");
          searchAnalyser = new fengmap.FMSearchAnalyser(map);
        });

        map.on("mapClickNode", function (event) {
          if (!event.mapCoord) return;
          if (point.length < 1) {
            x = event.mapCoord && event.mapCoord.x;
            y = event.mapCoord && event.mapCoord.y;

            event.mapCoord &&
              event.mapCoord &&
              point.push({
                x: x,
                y: y,
              });

            // 开启hover事件效果
            map.hoverFilterFunction = function () {
              return true;
            };
            // 开始监听悬停事件
            map.on("mapHoverNode", function (event) {
              console.log("模型悬停事件！");

              if (point.length === 1) {
                point.push({
                  x: event.eventInfo.coord && event.eventInfo.coord.x,
                  y: event.eventInfo.coord && event.eventInfo.coord.y,
                });
              } else if (point.length === 2) {
                point.pop();
                point.push({
                  x: event.eventInfo.coord && event.eventInfo.coord.x,
                  y: event.eventInfo.coord && event.eventInfo.coord.y,
                });
                if (point.length === 2) {
                  let x1 = point[0].x;
                  let y1 = point[0].y;
                  let x2 = point[1].x;
                  let y2 = point[1].y;

                  width = x2 - x1;
                  height = y1 - y2;

                  searchByWidthOrHeight();
                }
              }
              // console.log(point);
            });
          }

          if (point.length === 2) {
            let x1 = point[0].x;
            let y1 = point[0].y;
            let x2 = point[1].x;
            let y2 = point[1].y;

            width = x2 - x1;
            height = y1 - y2;

            searchByWidthOrHeight();
            // 选取完毕，关闭hover事件效果
            map.hoverFilterFunction = function () {
              return false;
            };
            point = [];
          }

          if (event.nodeType === fengmap.FMNodeType.MODEL) {
            let model = event.target;
            let index = array.indexOf(model.FID);
            if (index != -1) {
              //将选中元素从数组中移除
              array.splice(index, 1);
              //渲染model恢复回主题中的设置
              setModelToDefault(model);
            } else {
              //将选中元素添加到数组中
              array.push(model.FID);
              // 渲染model为自定义颜色
              setModelRender(model);
            }
          }
        });
      }

      /**
       * 设置model颜色、透明度、边线颜色
       * */
      function setModelRender(model) {
        let modelColor = "#FFB6C1"; //模型颜色
        let lineColor = "#0000CD"; //模型边线颜色
        let alpha = 1; //颜色透明度
        if (model) {
          //修改模型颜色及透明度
          model.setColor(modelColor, alpha);
          //修改模型边线的颜色及透明度
          model.setStrokeColor(lineColor, alpha);
        }
      }

      /**
       * 修改model恢复到主题中的设置
       * */
      function setModelToDefault(model) {
        if (model) {
          //将模型的颜色及透明度恢复回主题中的设置
          model.setColorToDefault();
          //将模型边线的颜色及透明度恢复回主题中的设置
          model.setStrokeColorToDefault();
        }
      }

      /**
       * 周边查询
       **/
      function searchByRadius() {
        if (!x || !y || !selectR) return;
        if (point.length < 2) return;
        // 重置页面渲染
        resetRender();

        // 创建搜索条件对象
        const requestParam = {};
        requestParam.groupID = map.focusGroupID;
        requestParam.nodeType = fengmap.FMNodeType.MODEL;
        requestParam.circle = {
          // 查询范围中心点坐标
          center: {
            x: x,
            y: y,
          },
          // 查询范围半径
          radius: selectR
        };
        searchRes = searchByParams(requestParam);

        // 渲染搜索结果表格
        renderSearchResult(searchRes);

        // 创建圆形标注
        addCircleMarker(x, y, selectR);

        // 添加marker
        if (searchRes.length > 0) {
          for (let i = 0; i < searchRes.length; i++) {
            let model = searchRes[i];
            // 添加marker
            // addMarkers(model);
            setModelRender(model.target);
          }
        }
      }

      /**
       * 重置页面渲染
       **/
      function resetRender() {
        // 移除marker
        removeMarkers();

        // 移除polygonMarker
        removePolygonMarkers();

        // 选中颜色还原
        if (searchRes.length) {
          for (let i = 0; i < searchRes.length; i++) {
            let model = searchRes[i];
            // 置颜色为初始值
            setModelToDefault(model.target);
          }
        }

        // 隐藏搜索列表
        resTableDom.style.display = "none";
      }

      /**
       * 根据参数信息进行搜索
       * keyword: 搜索关键字
       * gids： 楼层id，'all':所有楼层
       * nodeType：fengmap.FMNodeType
       * fid: 模型FID,整个建筑内唯一ID
       * */
      function searchByParams(params) {
        if (map == null) {
          return;
        }

        let searchRequest = new fengmap.FMSearchRequest();

        // 配置groupID参数
        if (params.groupID) {
          searchRequest.groupID = params.groupID;
        }

        // 配置FID参数
        if (params.FID) {
          searchRequest.FID = params.FID;
        }

        // 配置nodeType参数
        if (params.nodeType != null) {
          searchRequest.nodeType = params.nodeType;
        }

        // 周边查询（圆形区域）
        if (params.circle) {
          searchRequest.circle = params.circle;
        }

        // 周边查询（矩形区域）
        if (params.polygon) {
          searchRequest.polygon = params.polygon;
        }

        let searchType = ["SINGLE"];
        if (params.circle) {
          searchType.push("CIRCLE");
        }
        if (params.polygon) {
          searchType.push("POLYGON");
        }

        let sortRes = searchAnalyser.getQueryResult(searchRequest, searchType);

        return sortRes;
      }

      /**
       * 根据FID搜索地图
       * */
      function findModelByFid(fid) {
        const params = {};
        params.FID = fid;
        params.nodeType = fengmap.FMNodeType.MODEL;
        let result = searchByParams(params);
        if (result.length > 0) {
          let model = result[0];
          // 打印model信息
          console.log("选中model信息", model);
          if (model != null) {
            // 视野中心移动到指定位置,如果不是当前聚焦层，将先设置目标层为聚焦层在跳转
            const coord = {
              x: model.mapCoord.x,
              y: model.mapCoord.y,
              groupID: model.groupID,
            };
            map.moveTo(coord);

            // 渲染当前设置的模型元素处于高亮状态
            let target = model.target;
            if (target) {
              if (selectedModel && selectedModel.FID != target.FID) {
                selectedModel.selected = false;
              }
              target.selected = true;
              selectedModel = target;
            }
          }
        }
      }

      /**
       * 根据model对象添加Marker
       * */
      function addMarkers(model) {
        // 获取当前聚焦楼层
        if (model.typeID === 300000) {
          // 其他操作
          return;
        }
        let group = map.getFMGroup(model.groupID);
        // 返回当前层中第一个imageMarkerLayer,如果没有，则自动创建
        let layer = group.getOrCreateLayer("imageMarker");
        // 模型中心点坐标
        let coord = model.mapCoord;
        // 创建imageMarker
        let im = new fengmap.FMImageMarker({
          x: coord.x,
          y: coord.y,
          height: 2,
          url: "./images/redImageMarker.png",
          size: 32,
        });
        layer.addMarker(im);
      }

      /**
       * 删除Marker
       * */
      function removeMarkers() {
        // 获取多楼层Marker
        map.getLayerByAlias(map.focusGroupID, "imageMarker", function (layer) {
          if (layer) {
            // 移除该层的所有图片标注
            layer.removeAll();
          }
        });
      }

      /**
       * 删除FMPolygonMarker
       * */
      function removePolygonMarkers() {
        // 获取多楼层Marker
        if (!polygonLayer) return;
        polygonLayer.removeAll();
      }

      /**
       * 渲染搜索结果列表展示
       * */
      function renderSearchResult(result) {
        let tableCont = document.getElementById("tableCont");
        if (result && result.length > 0) {
          let resultHtml = "";
          for (let i = 0; i < result.length; i++) {
            let model = result[i];
            if (!model.name) {
              continue;
            }
            let num = parseInt(i) + parseInt(1);
            let modelName = model.name;
            resultHtml +=
              "<tr onClick=\"findModelByFid('" +
              model.FID +
              "')\"><td>" +
              num +
              "</td><td>" +
              modelName +
              "</td><td>" +
              model.FID +
              "</td><td>" +
              model.groupID +
              "</td><td>" +
              model.mapCoord.x +
              "</td><td>" +
              model.mapCoord.y +
              "</td><td>" +
              model.mapCoord.z +
              "</td></tr>";
          }
          tableCont.innerHTML = resultHtml;
          resTableDom.style.display = "block";
        } else {
          tableCont.innerHTML = "";
          resTableDom.style.display = "none";
        }

        // 点击行选中行颜色
        let trDom = tableCont.childNodes;
        for (let i = 0; i < trDom.length; i++) {
          trDom[i].addEventListener("click", function (event) {
            let parentNode = event.target.parentNode;
            for (let j = 0; j < trDom.length; j++) {
              if (parentNode == trDom[j]) {
                trDom[j].classList.add("active");
              } else {
                trDom[j].classList.remove("active");
              }
            }
          });
        }
      }

      /**
       * 创建圆形标注
       **/
      function addCircleMarker(x, y, radius) {
        // 获取当前聚焦楼层
        let group = map.getFMGroup(map.focusGroupID);
        // 创建PolygonMarkerLayer
        if (!polygonLayer) {
          polygonLayer = new fengmap.FMPolygonMarkerLayer();
          group.addLayer(polygonLayer);
        } else {
          polygonLayer.removeAll();
        }
        let circleMaker = new fengmap.FMPolygonMarker({
          // 设置颜色
          color: "#3CF9DF",
          // 设置透明度
          alpha: 0.3,
          // 设置边框线的宽度
          lineWidth: 3,
          // 设置高度
          height: 3,
          // 设置圆形中心点坐标
          points: {
            // 设置为圆形
            type: "circle",
            // 设置此形状的中心坐标
            center: {
              x: x,
              y: y,
            },
            // 设置半径
            radius: radius,
            // 设置段数，默认为40段
            segments: 40,
          },
        });
        polygonLayer.addMarker(circleMaker);
      }

      /**
       * 周边查询
       **/
      function searchByWidthOrHeight() {
        if (!width || !height) return;
        if (point.length < 2) return;
        // 重置页面渲染
        resetRender();

        // 创建搜索条件对象
        const requestParam = {};
        requestParam.groupID = map.focusGroupID;
        requestParam.nodeType = fengmap.FMNodeType.MODEL;
        requestParam.polygon = [
          {
            x: point[0].x,
            y: point[0].y,
          },
          {
            x: point[1].x,
            y: point[0].y,
          },
          {
            x: point[1].x,
            y: point[1].y,
          },
          {
            x: point[0].x,
            y: point[1].y,
          },
        ];
        searchRes = searchByParams(requestParam);

        // 渲染搜索结果表格
        renderSearchResult(searchRes);

        // 创建矩形标注
        addRectangleMarker(point, width, height);

        // 添加marker
        if (searchRes.length > 0) {
          for (let i = 0; i < searchRes.length; i++) {
            let model = searchRes[i];
            //添加marker
            setModelRender(model.target);
          }
        }
      }

      /**
       * 创建矩形标注
       **/
      function addRectangleMarker(point, width, height) {
        // 获取当前聚焦楼层
        let group = map.getFMGroup(map.focusGroupID);
        // 创建PolygonMarkerLayer
        if (!polygonLayer) {
          polygonLayer = new fengmap.FMPolygonMarkerLayer();
          group.addLayer(polygonLayer);
        } else {
          polygonLayer.removeAll();
        }
        // console.log('矩形width', width, '矩形height', height);
        let rectangleMaker = new fengmap.FMPolygonMarker({
          // 设置颜色
          color: "#3CF9DF",
          // 设置透明度
          alpha: 0.2,
          // 设置边框线的宽度
          lineWidth: 1,
          // 设置高度
          height: 3,
          points: {
            // 设置为矩形
            type: "rectangle",
            startPoint: {
              x: point[0].x,
              y: point[0].y,
            },
            width: width,
            height: height,
            // 设置段数，默认为40段
            segments: 40,
          },
        });
        polygonLayer.addMarker(rectangleMaker);
      }
    </script>
  </body>
</html>
